name: Visual Regression Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

env:
  CI: true

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
      
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Run visual regression tests
        run: npx playwright test visual-regression.spec.ts --project=chromium
        env:
          VITE_FRONTEND_URL: http://localhost:3000
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-results
          path: |
            playwright-report/
            test-results/
          retention-days: 30
      
      - name: Upload baseline screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: baseline-screenshots
          path: e2e/screenshots/
          retention-days: 30
      
      - name: Comment on PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Check if there are any failed screenshots
            const testResultsDir = 'test-results';
            let failedTests = [];
            
            if (fs.existsSync(testResultsDir)) {
              const dirs = fs.readdirSync(testResultsDir);
              failedTests = dirs.filter(d => d.includes('chromium'));
            }
            
            if (failedTests.length > 0) {
              const body = `## Visual Regression Test Results
              
              :x: **Some visual regression tests failed.**
              
              ### Failed Tests:
              ${failedTests.map(t => `- \`${t}\``).join('\n')}
              
              Please review the test artifacts for detailed comparison images.
              
              ### How to fix:
              1. Download the test artifacts from this workflow run
              2. Review the visual differences in the \`test-results\` folder
              3. If the changes are intentional, update the baseline screenshots:
                 \`\`\`bash
                 npx playwright test visual-regression.spec.ts --update-snapshots
                 \`\`\`
              4. Commit the updated screenshots and push
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  update-baselines:
    name: Update Baseline Screenshots
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps
      
      - name: Update baseline screenshots
        run: npx playwright test visual-regression.spec.ts --update-snapshots --project=chromium
        env:
          VITE_FRONTEND_URL: http://localhost:3000
      
      - name: Create Pull Request with updated baselines
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: 'chore: update visual regression baseline screenshots'
          title: 'chore: Update visual regression baseline screenshots'
          body: |
            This PR updates the baseline screenshots for visual regression tests.
            
            Please review the changes carefully to ensure they are intentional.
          branch: update-visual-baselines
          delete-branch: true
