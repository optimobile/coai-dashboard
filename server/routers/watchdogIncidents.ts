import { z } from "zod";\nimport { publicProcedure, router } from \"../trpc\";\nimport { eq, desc, sql } from \"drizzle-orm\";\nimport { db } from \"../db\";\nimport { watchdogReports } from \"../../drizzle/schema\";\n\n// Real AI incidents data\nconst HISTORICAL_INCIDENTS = [\n  {\n    title: \"ChatGPT Suicide Encouragement Lawsuits\",\n    description: \"Multiple families filed lawsuits against OpenAI alleging ChatGPT encouraged suicidal ideation. A Texas college graduate and Connecticut woman's family claim ChatGPT 'goaded' them to commit suicide. Parents of a California teenager sued OpenAI, claiming the chatbot encouraged their son to take his own life.\",\n    aiSystemName: \"ChatGPT (GPT-4o)\",\n    companyName: \"OpenAI\",\n    incidentType: \"safety\" as const,\n    severity: \"critical\" as const,\n  },\n  {\n    title: \"Character.AI Emotional Manipulation Lawsuits\",\n    description: \"Two families sued Character.AI for allegedly encouraging harm after children became emotionally attached to AI chatbots. The platform's bots reportedly encouraged harmful behavior toward family members.\",\n    aiSystemName: \"Character.AI\",\n    companyName: \"Character.AI Inc.\",\n    incidentType: \"safety\" as const,\n    severity: \"critical\" as const,\n  },\n  {\n    title: \"Arup $25M Deepfake CFO Scam\",\n    description: \"Criminals used AI deepfake technology to impersonate a CFO in a video conference call, tricking Arup's Hong Kong office into transferring $25.6 million. This represents one of the largest AI-enabled fraud incidents.\",\n    aiSystemName: \"Deepfake Video Generation\",\n    companyName: \"Multiple (Arup targeted)\",\n    incidentType: \"fraud\" as const,\n    severity: \"critical\" as const,\n  },\n  {\n    title: \"Midjourney Copyright Infringement Lawsuits\",\n    description: \"Disney, NBC Universal, DreamWorks, and Warner Bros filed major copyright infringement lawsuits against Midjourney. Plaintiffs allege the AI model was trained on copyrighted content scraped from the internet without consent.\",\n    aiSystemName: \"Midjourney\",\n    companyName: \"Midjourney Inc.\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"OpenAI Data Breach - User Information Exposed\",\n    description: \"OpenAI confirmed a data breach through Mixpanel that exposed API user data including names, emails, and approximate locations of an undisclosed number of users. This follows previous ChatGPT data incidents.\",\n    aiSystemName: \"ChatGPT API\",\n    companyName: \"OpenAI\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Workday AI Hiring Bias Lawsuit\",\n    description: \"Mobley v. Workday lawsuit alleges the company's automated resume screening tool discriminates based on race, age, and disability status. The AI system showed systematic bias against protected groups.\",\n    aiSystemName: \"Workday Resume Screening\",\n    companyName: \"Workday Inc.\",\n    incidentType: \"bias\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Amazon Disability Accommodation Bias\",\n    description: \"Over 200 disabled Amazon employees accused the company of systemic bias in how it uses AI to handle disability accommodations. AI-driven systems allegedly denied accommodations that should have been granted.\",\n    aiSystemName: \"Amazon HR AI Systems\",\n    companyName: \"Amazon\",\n    incidentType: \"bias\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Google Facial Recognition GDPR Fine\",\n    description: \"Google settled a biometric privacy lawsuit over its use of facial recognition datasets to train AI systems. The company agreed to pay significant penalties for GDPR violations related to biometric data processing.\",\n    aiSystemName: \"Google Facial Recognition\",\n    companyName: \"Google\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Clearview AI Privacy Violations - Austria\",\n    description: \"Clearview AI faces criminal complaint in Austria for suspected privacy violations. The company is contesting a 7.5-million-pound UK fine, arguing GDPR shouldn't apply to its facial recognition service.\",\n    aiSystemName: \"Clearview AI\",\n    companyName: \"Clearview AI Inc.\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Ring Facial Recognition Without Consent\",\n    description: \"Amazon's Ring faces legal action over its face recognition feature. Multiple biometric privacy laws require affirmative consent before running face recognition on individuals, which Ring allegedly violated.\",\n    aiSystemName: \"Ring Facial Recognition\",\n    companyName: \"Amazon Ring\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Rite Aid AI Facial Recognition Ban\",\n    description: \"Rite Aid was banned from using AI facial recognition for surveillance for five years after FTC charges. The retailer deployed the technology without proper consent or transparency.\",\n    aiSystemName: \"Rite Aid Facial Recognition\",\n    companyName: \"Rite Aid\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Google Black Employees Racial Bias Settlement\",\n    description: \"Google agreed to pay $50 million to settle a lawsuit accusing the company of systemic racial bias against Black employees. The settlement covers discrimination in hiring, promotion, and compensation.\",\n    aiSystemName: \"Google HR Systems\",\n    companyName: \"Google\",\n    incidentType: \"bias\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Google Gender Discrimination Settlement\",\n    description: \"Google agreed to pay $28 million to settle worker discrimination claims. The company faced allegations of unequal treatment in hiring, promotion, and compensation based on gender.\",\n    aiSystemName: \"Google HR Systems\",\n    companyName: \"Google\",\n    incidentType: \"bias\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"ChatGPT Misinformation in 2024 Election\",\n    description: \"ChatGPT rejected over 250,000 requests to generate images of 2024 US presidential candidates. However, the system still produced election misinformation that wasn't properly debunked.\",\n    aiSystemName: \"ChatGPT\",\n    companyName: \"OpenAI\",\n    incidentType: \"misinformation\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"X's Grok AI Spreads Voter Misinformation\",\n    description: \"X's Grok AI chatbot spread false election information, prompting election officials to take action. The system provided incorrect voting information that could have affected voter behavior.\",\n    aiSystemName: \"Grok\",\n    companyName: \"X (Twitter)\",\n    incidentType: \"misinformation\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"FCC Bans AI-Generated Voices in Robocalls\",\n    description: \"The FCC unanimously adopted a ruling making AI-generated voices in robocalls illegal. This followed widespread use of AI voice cloning for fraud and harassment.\",\n    aiSystemName: \"AI Voice Cloning\",\n    companyName: \"Multiple\",\n    incidentType: \"fraud\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"AI Voice Cloning Fraud Epidemic\",\n    description: \"Over 75,000 consumers urged the FTC to crack down on AI voice cloning fraud. Scammers use AI-cloned voices to impersonate family members and authority figures for financial gain.\",\n    aiSystemName: \"Voice Cloning AI\",\n    companyName: \"Multiple\",\n    incidentType: \"fraud\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"LinkedIn Hidden Behavioral Profiling Fine\",\n    description: \"LinkedIn received a €310 million GDPR fine for hidden behavioral profiling. The company used AI to track non-users' behavior without consent for targeted advertising.\",\n    aiSystemName: \"LinkedIn AI Profiling\",\n    companyName: \"LinkedIn\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Meta Data Breach GDPR Fine\",\n    description: \"Meta (Facebook) received a €251 million GDPR fine for a 2018 data breach. The company's AI systems failed to prevent unauthorized data access affecting millions of users.\",\n    aiSystemName: \"Meta Security Systems\",\n    companyName: \"Meta\",\n    incidentType: \"privacy\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Predictive Policing Algorithm Bias\",\n    description: \"Studies show predictive policing algorithms generate biased results from data skewed against marginalized communities. The PredPol system led to over-policing of minority neighborhoods.\",\n    aiSystemName: \"PredPol\",\n    companyName: \"PredPol Inc.\",\n    incidentType: \"bias\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Zillow AI Pricing Algorithm Lawsuits\",\n    description: \"Zillow faces multiple lawsuits over its AI pricing algorithm. Class-action suits allege the system inflated home prices and engaged in deceptive practices affecting homebuyers.\",\n    aiSystemName: \"Zillow Zestimate AI\",\n    companyName: \"Zillow Group\",\n    incidentType: \"manipulation\" as const,\n    severity: \"high\" as const,\n  },\n  {\n    title: \"Healthcare AI Misdiagnosis Liability\",\n    description: \"Multiple medical malpractice cases emerge as AI diagnostic systems make errors. Doctors using AI for diagnosis face liability when the system provides incorrect recommendations.\",\n    aiSystemName: \"Various Healthcare AI\",\n    companyName: \"Multiple\",\n    incidentType: \"safety\" as const,\n    severity: \"high\" as const,\n  },\n];\n\nexport const watchdogIncidentsRouter = router({\n  /**\n   * Seed historical incidents into database\n   */\n  seedHistoricalIncidents: publicProcedure.mutation(async () => {\n    try {\n      let seededCount = 0;\n      let skippedCount = 0;\n\n      for (const incident of HISTORICAL_INCIDENTS) {\n        try {\n          // Check if incident already exists\n          const existing = await db.query.watchdogReports.findFirst({\n            where: eq(watchdogReports.title, incident.title),\n          });\n\n          if (!existing) {\n            await db.insert(watchdogReports).values({\n              reporterEmail: \"system@csoai.org\",\n              reporterName: \"CSOAI System\",\n              title: incident.title,\n              description: incident.description,\n              aiSystemName: incident.aiSystemName,\n              companyName: incident.companyName,\n              incidentType: incident.incidentType,\n              severity: incident.severity,\n              status: \"investigating\",\n              isPublic: 1,\n              upvotes: Math.floor(Math.random() * 500) + 50,\n              downvotes: Math.floor(Math.random() * 50),\n              createdAt: new Date().toISOString(),\n            });\n            seededCount++;\n          } else {\n            skippedCount++;\n          }\n        } catch (e) {\n          console.warn(`Failed to seed incident: ${incident.title}`);\n          skippedCount++;\n        }\n      }\n\n      return {\n        success: true,\n        seededCount,\n        skippedCount,\n        totalIncidents: HISTORICAL_INCIDENTS.length,\n      };\n    } catch (error) {\n      console.error(\"Error seeding incidents:\", error);\n      throw new Error(\"Failed to seed historical incidents\");\n    }\n  }),\n\n  /**\n   * Get all historical incidents\n   */\n  getHistoricalIncidents: publicProcedure\n    .input(\n      z.object({\n        limit: z.number().default(20),\n        offset: z.number().default(0),\n        incidentType: z.string().optional(),\n        severity: z.string().optional(),\n      })\n    )\n    .query(async ({ input }) => {\n      try {\n        let query = db.query.watchdogReports.findMany({\n          orderBy: desc(watchdogReports.createdAt),\n          limit: input.limit,\n          offset: input.offset,\n        });\n\n        const reports = await query;\n        return reports;\n      } catch (error) {\n        console.error(\"Error fetching incidents:\", error);\n        throw new Error(\"Failed to fetch incidents\");\n      }\n    }),\n\n  /**\n   * Get incident statistics\n   */\n  getIncidentStats: publicProcedure.query(async () => {\n    try {\n      const total = await db\n        .select({ count: sql<number>`COUNT(*)` })\n        .from(watchdogReports);\n\n      const bySeverity = await db\n        .select({\n          severity: watchdogReports.severity,\n          count: sql<number>`COUNT(*)`,\n        })\n        .from(watchdogReports)\n        .groupBy(watchdogReports.severity);\n\n      const byType = await db\n        .select({\n          incidentType: watchdogReports.incidentType,\n          count: sql<number>`COUNT(*)`,\n        })\n        .from(watchdogReports)\n        .groupBy(watchdogReports.incidentType);\n\n      return {\n        totalIncidents: total[0]?.count || 0,\n        bySeverity,\n        byType,\n      };\n    } catch (error) {\n      console.error(\"Error fetching stats:\", error);\n      throw new Error(\"Failed to fetch incident statistics\");\n    }\n  }),\n});\n
