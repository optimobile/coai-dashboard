import express from \"express\";\nimport crypto from \"crypto\";\nimport { generateBadgeSVG, generateBadgePackage } from \"../services/badge-generator\";\n\nconst router = express.Router();\n\n// In-memory badge store (in production, use database)\nconst badges: Record<string, any> = {};\n\n// Generate a new badge\nrouter.post(\"/generate\", (req, res) => {\n  try {\n    const { userName, certificationLevel } = req.body;\n\n    if (!userName || !certificationLevel) {\n      return res.status(400).json({ error: \"Missing required fields\" });\n    }\n\n    const badgePackage = generateBadgePackage({\n      userId: Math.floor(Math.random() * 1000000),\n      userName,\n      certificationLevel,\n      issueDate: new Date(),\n    });\n\n    // Store badge\n    badges[badgePackage.badgeToken] = {\n      ...badgePackage,\n      userName,\n      certificationLevel,\n      issuedAt: new Date(),\n      shareCount: 0,\n      clickCount: 0,\n      linkedInShares: 0,\n    };\n\n    res.json({\n      success: true,\n      badge: badgePackage,\n    });\n  } catch (error) {\n    console.error(\"Error generating badge:\", error);\n    res.status(500).json({ error: \"Failed to generate badge\" });\n  }\n});\n\n// Get badge details\nrouter.get(\"/:badgeToken\", (req, res) => {\n  try {\n    const { badgeToken } = req.params;\n    const badge = badges[badgeToken];\n\n    if (!badge) {\n      return res.status(404).json({ error: \"Badge not found\" });\n    }\n\n    // Increment click count\n    badge.clickCount = (badge.clickCount || 0) + 1;\n\n    res.json(badge);\n  } catch (error) {\n    console.error(\"Error fetching badge:\", error);\n    res.status(500).json({ error: \"Failed to fetch badge\" });\n  }\n});\n\n// Get badge image (SVG)\nrouter.get(\"/image/:badgeToken\", (req, res) => {\n  try {\n    const { badgeToken } = req.params;\n    const badge = badges[badgeToken];\n\n    if (!badge) {\n      return res.status(404).json({ error: \"Badge not found\" });\n    }\n\n    const svgString = generateBadgeSVG(badge.userName, badge.certificationLevel);\n\n    res.setHeader(\"Content-Type\", \"image/svg+xml\");\n    res.setHeader(\"Cache-Control\", \"public, max-age=86400\");\n    res.send(svgString);\n  } catch (error) {\n    console.error(\"Error generating badge image:\", error);\n    res.status(500).json({ error: \"Failed to generate badge image\" });\n  }\n});\n\n// Track badge share\nrouter.post(\"/:badgeToken/share\", (req, res) => {\n  try {\n    const { badgeToken } = req.params;\n    const { platform } = req.body;\n\n    const badge = badges[badgeToken];\n    if (!badge) {\n      return res.status(404).json({ error: \"Badge not found\" });\n    }\n\n    badge.shareCount = (badge.shareCount || 0) + 1;\n\n    if (platform === \"linkedin\") {\n      badge.linkedInShares = (badge.linkedInShares || 0) + 1;\n    }\n\n    res.json({ success: true, badge });\n  } catch (error) {\n    console.error(\"Error tracking share:\", error);\n    res.status(500).json({ error: \"Failed to track share\" });\n  }\n});\n\n// Get badge statistics\nrouter.get(\"/:badgeToken/stats\", (req, res) => {\n  try {\n    const { badgeToken } = req.params;\n    const badge = badges[badgeToken];\n\n    if (!badge) {\n      return res.status(404).json({ error: \"Badge not found\" });\n    }\n\n    res.json({\n      totalShares: badge.shareCount || 0,\n      totalClicks: badge.clickCount || 0,\n      linkedInShares: badge.linkedInShares || 0,\n      issuedAt: badge.issuedAt,\n      certificationLevel: badge.certificationLevel,\n    });\n  } catch (error) {\n    console.error(\"Error fetching badge stats:\", error);\n    res.status(500).json({ error: \"Failed to fetch badge statistics\" });\n  }\n});\n\nexport default router;\n
