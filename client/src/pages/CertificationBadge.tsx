import React, { useEffect, useState } from "react";
import { useParams } from "wouter";
import { motion } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Share2, Download, Copy, CheckCircle, AlertCircle } from "lucide-react";
import { trpc } from "@/lib/trpc";

export default function CertificationBadge() {\n  const { badgeToken } = useParams<{ badgeToken: string }>();\n  const [copied, setCopied] = useState(false);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  // Fetch badge details\n  const { data: badgeData, isLoading } = trpc.certificationBadges.getBadgeByToken.useQuery(\n    { badgeToken: badgeToken || \"\" },\n    { enabled: !!badgeToken }\n  );\n\n  // Fetch badge stats\n  const { data: stats } = trpc.certificationBadges.getBadgeStats.useQuery(\n    { badgeToken: badgeToken || \"\" },\n    { enabled: !!badgeToken }\n  );\n\n  useEffect(() => {\n    setLoading(isLoading);\n    if (badgeData) {\n      setError(null);\n    }\n  }, [isLoading, badgeData]);\n\n  if (loading) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-50 to-blue-50 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <div className=\"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600\"></div>\n          <p className=\"mt-4 text-gray-600\">Loading certification badge...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (error || !badgeData) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-emerald-50 to-blue-50 flex items-center justify-center\">\n        <Card className=\"max-w-md p-8 text-center\">\n          <AlertCircle className=\"h-12 w-12 text-red-500 mx-auto mb-4\" />\n          <h1 className=\"text-2xl font-bold text-gray-900 mb-2\">Badge Not Found</h1>\n          <p className=\"text-gray-600 mb-6\">\n            This certification badge could not be found. Please check the URL and try again.\n          </p>\n          <Button onClick={() => (window.location.href = \"/\")} className=\"w-full\">\n            Return to Home\n          </Button>\n        </Card>\n      </div>\n    );\n  }\n\n  const { badge, user } = badgeData;\n  const badgeConfig: Record<string, { name: string; color: string; icon: string }> = {\n    level_1: { name: \"Level 1 Analyst\", color: \"emerald\", icon: \"üèÖ\" },\n    level_2: { name: \"Level 2 Analyst\", color: \"blue\", icon: \"ü•à\" },\n    level_3: { name: \"Level 3 Analyst\", color: \"amber\", icon: \"ü•á\" },\n    expert: { name: \"Expert Analyst\", color: \"purple\", icon: \"‚≠ê\" },\n  };\n\n  const config = badgeConfig[badge.certificationLevel] || badgeConfig.level_1;\n  const colorMap: Record<string, string> = {\n    emerald: \"from-emerald-500 to-emerald-700\",\n    blue: \"from-blue-500 to-blue-700\",\n    amber: \"from-amber-500 to-amber-700\",\n    purple: \"from-purple-500 to-purple-700\",\n  };\n\n  const handleCopyEmbed = () => {\n    navigator.clipboard.writeText(badge.badgeEmbedCode || \"\");\n    setCopied(true);\n    setTimeout(() => setCopied(false), 2000);\n  };\n\n  const handleDownloadBadge = async () => {\n    try {\n      const response = await fetch(`/api/badge/image/${badgeToken}.png`);\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement(\"a\");\n      a.href = url;\n      a.download = `csoai-badge-${user?.name?.replace(/\\s+/g, \"-\")}.png`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    } catch (error) {\n      console.error(\"Error downloading badge:\", error);\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-emerald-50 via-blue-50 to-purple-50 py-12 px-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        {/* Header */}\n        <motion.div\n          initial={{ opacity: 0, y: -20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"text-center mb-12\"\n        >\n          <h1 className=\"text-4xl font-bold text-gray-900 mb-2\">CSOAI Certification Badge</h1>\n          <p className=\"text-lg text-gray-600\">Verified AI Safety Analyst</p>\n        </motion.div>\n\n        <div className=\"grid md:grid-cols-2 gap-8\">\n          {/* Badge Display */}\n          <motion.div\n            initial={{ opacity: 0, scale: 0.9 }}\n            animate={{ opacity: 1, scale: 1 }}\n            className=\"flex flex-col items-center\"\n          >\n            <Card className=\"w-full p-8 text-center bg-white shadow-xl\">\n              <div className={`inline-block bg-gradient-to-br ${colorMap[config.color]} rounded-full p-8 mb-6`}>\n                <div className=\"text-6xl\">{config.icon}</div>\n              </div>\n\n              <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">{config.name}</h2>\n              <p className=\"text-xl font-semibold text-gray-700 mb-4\">{user?.name}</p>\n\n              <div className=\"border-t pt-4 mt-4\">\n                <p className=\"text-sm text-gray-600 mb-2\">Issued: {badge.issuedAt && new Date(badge.issuedAt).toLocaleDateString()}</p>\n                {badge.expiresAt && (\n                  <p className=\"text-sm text-gray-600 mb-2\">\n                    Expires: {new Date(badge.expiresAt).toLocaleDateString()}\n                  </p>\n                )}\n              </div>\n\n              <div className=\"mt-6 flex items-center justify-center text-emerald-600 font-semibold\">\n                <CheckCircle className=\"h-5 w-5 mr-2\" />\n                Verified at csoai.org\n              </div>\n            </Card>\n\n            {/* Action Buttons */}\n            <div className=\"w-full mt-6 space-y-3\">\n              <Button\n                onClick={handleDownloadBadge}\n                className=\"w-full bg-emerald-600 hover:bg-emerald-700 text-white\"\n              >\n                <Download className=\"h-4 w-4 mr-2\" />\n                Download Badge (PNG)\n              </Button>\n\n              <Button\n                onClick={handleCopyEmbed}\n                variant=\"outline\"\n                className=\"w-full border-emerald-600 text-emerald-600 hover:bg-emerald-50\"\n              >\n                <Copy className=\"h-4 w-4 mr-2\" />\n                {copied ? \"Copied!\" : \"Copy Embed Code\"}\n              </Button>\n            </div>\n          </motion.div>\n\n          {/* Badge Info & Sharing */}\n          <motion.div\n            initial={{ opacity: 0, x: 20 }}\n            animate={{ opacity: 1, x: 0 }}\n            className=\"space-y-6\"\n          >\n            {/* Analyst Profile */}\n            <Card className=\"p-6 bg-white\">\n              <h3 className=\"text-lg font-bold text-gray-900 mb-4\">Analyst Profile</h3>\n              <div className=\"space-y-3\">\n                <div>\n                  <p className=\"text-sm text-gray-600\">Name</p>\n                  <p className=\"text-lg font-semibold text-gray-900\">{user?.name}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-gray-600\">Email</p>\n                  <p className=\"text-lg font-semibold text-gray-900\">{user?.email}</p>\n                </div>\n                <div>\n                  <p className=\"text-sm text-gray-600\">Certification Level</p>\n                  <p className=\"text-lg font-semibold text-gray-900\">{config.name}</p>\n                </div>\n              </div>\n            </Card>\n\n            {/* Badge Statistics */}\n            {stats && (\n              <Card className=\"p-6 bg-white\">\n                <h3 className=\"text-lg font-bold text-gray-900 mb-4\">Badge Activity</h3>\n                <div className=\"space-y-3\">\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-600\">Total Shares</span>\n                    <span className=\"font-semibold text-gray-900\">{stats.totalShares}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-600\">Profile Views</span>\n                    <span className=\"font-semibold text-gray-900\">{stats.totalClicks}</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span className=\"text-gray-600\">LinkedIn Shares</span>\n                    <span className=\"font-semibold text-gray-900\">{stats.linkedInShares}</span>\n                  </div>\n                </div>\n              </Card>\n            )}\n\n            {/* Share Options */}\n            <Card className=\"p-6 bg-white\">\n              <h3 className=\"text-lg font-bold text-gray-900 mb-4 flex items-center\">\n                <Share2 className=\"h-5 w-5 mr-2\" />\n                Share Your Badge\n              </h3>\n              <div className=\"space-y-3\">\n                <a\n                  href={`https://www.linkedin.com/feed/?shareActive=true&text=I%20just%20earned%20my%20${config.name}%20from%20CSOAI!%20%F0%9F%8E%89%20${badge.verificationUrl}`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"block w-full p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-center font-semibold transition\"\n                >\n                  Share on LinkedIn\n                </a>\n                <a\n                  href={`https://twitter.com/intent/tweet?text=I%27m%20now%20${config.name}%20from%20@CSOAI!%20%F0%9F%8E%93%20${badge.verificationUrl}`}\n                  target=\"_blank\"\n                  rel=\"noopener noreferrer\"\n                  className=\"block w-full p-3 bg-sky-500 hover:bg-sky-600 text-white rounded-lg text-center font-semibold transition\"\n                >\n                  Share on Twitter\n                </a>\n                <a\n                  href={`mailto:?subject=${user?.name}%20is%20now%20${config.name}&body=Check%20out%20my%20new%20CSOAI%20certification!%20${badge.verificationUrl}`}\n                  className=\"block w-full p-3 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-center font-semibold transition\"\n                >\n                  Share via Email\n                </a>\n              </div>\n            </Card>\n\n            {/* Verification Info */}\n            <Card className=\"p-6 bg-emerald-50 border border-emerald-200\">\n              <h3 className=\"text-lg font-bold text-emerald-900 mb-2\">Verification</h3>\n              <p className=\"text-sm text-emerald-800 mb-3\">\n                This badge is verified and publicly accessible. Anyone can view this profile using the badge link.\n              </p>\n              <p className=\"text-xs text-emerald-700 font-mono break-all\">\n                Badge ID: {badgeToken}\n              </p>\n            </Card>\n          </motion.div>\n        </div>\n\n        {/* Footer */}\n        <motion.div\n          initial={{ opacity: 0, y: 20 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"text-center mt-12\"\n        >\n          <p className=\"text-gray-600 mb-4\">\n            Want to earn your own CSOAI certification badge?\n          </p>\n          <Button\n            onClick={() => (window.location.href = \"/training\")}\n            className=\"bg-emerald-600 hover:bg-emerald-700 text-white\"\n          >\n            Start Training\n          </Button>\n        </motion.div>\n      </div>\n    </div>\n  );\n}\n
